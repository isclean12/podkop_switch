#!/bin/sh

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Podkop —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
# –ê–≤—Ç–æ—Ä: isclean
# –í–µ—Ä—Å–∏—è: 1.0

CONFIG_FILE="/etc/config/podkop"
RESOLV_FILE="/tmp/resolv.conf.auto"
BACKUP_RESOLV="/tmp/resolv.conf.backup"

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–º–æ—â–∏
show_help() {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: podkop-switch [–∫–æ–º–∞–Ω–¥–∞]"
    echo ""
    echo "–ö–æ–º–∞–Ω–¥—ã:"
    echo "  on     - –í–∫–ª—é—á–∏—Ç—å Podkop"
    echo "  off    - –í—ã–∫–ª—é—á–∏—Ç—å Podkop —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞"
    echo "  status - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å Podkop"
    echo "  dns    - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    echo "  help   - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  podkop-switch on    - –í–∫–ª—é—á–∏—Ç—å Podkop"
    echo "  podkop-switch off   - –í—ã–∫–ª—é—á–∏—Ç—å Podkop"
    echo "  podkop-switch status - –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
check_status() {
    echo "=== –°—Ç–∞—Ç—É—Å Podkop ==="
    if /etc/init.d/podkop enabled; then
        echo "‚úÖ Podkop: –≤–∫–ª—é—á–µ–Ω –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É"
    else
        echo "‚ùå Podkop: –æ—Ç–∫–ª—é—á–µ–Ω –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–µ"
    fi
    
    if /etc/init.d/podkop running; then
        echo "‚úÖ Podkop: —Å–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞"
    else
        echo "‚ùå Podkop: —Å–ª—É–∂–±–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    fi
    
    if /etc/init.d/sing-box running; then
        echo "‚úÖ Sing-box: —Å–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞"
    else
        echo "‚ùå Sing-box: —Å–ª—É–∂–±–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    fi
    
    echo ""
    echo "=== DNS —Å–µ—Ä–≤–µ—Ä—ã ==="
    cat $RESOLV_FILE 2>/dev/null | grep nameserver
}

# –§—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è Podkop
turn_on() {
    echo "üîÑ –í–∫–ª—é—á–∞–µ–º Podkop..."
    
    # –í–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–±—ã
    /etc/init.d/podkop start
    /etc/init.d/sing-box start
    
    # –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
    /etc/init.d/podkop enable
    /etc/init.d/sing-box enable
    
    # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo "‚úÖ Podkop –≤–∫–ª—é—á–µ–Ω"
    check_status
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è Podkop
turn_off() {
    echo "üîÑ –í—ã–∫–ª—é—á–∞–µ–º Podkop..."
    
    # –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö DNS
    if [ -f "$RESOLV_FILE" ]; then
        cp "$RESOLV_FILE" "$BACKUP_RESOLV"
        echo "üìã –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è DNS –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á–∏–µ DNS —Å–µ—Ä–≤–µ—Ä—ã
    echo "nameserver 8.8.8.8" > "$RESOLV_FILE"
    echo "nameserver 1.1.1.1" >> "$RESOLV_FILE"
    echo "üì° –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤–Ω–µ—à–Ω–∏–µ DNS —Å–µ—Ä–≤–µ—Ä—ã"
    
    # –í—ã–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–±—ã
    /etc/init.d/podkop stop
    /etc/init.d/sing-box stop
    
    # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
    /etc/init.d/podkop disable
    /etc/init.d/sing-box disable
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º DNS —Å–µ—Ä–≤–∏—Å—ã
    /etc/init.d/dnsmasq restart
    /etc/init.d/odhcpd restart
    
    echo "‚åõ –ñ–¥—ë–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏..."
    sleep 5
    
    echo "‚úÖ Podkop –≤—ã–∫–ª—é—á–µ–Ω, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å"
    check_status
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ DNS
show_dns() {
    echo "=== –¢–µ–∫—É—â–∏–µ DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==="
    if [ -f "$RESOLV_FILE" ]; then
        cat "$RESOLV_FILE"
    else
        echo "–§–∞–π–ª $RESOLV_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    echo ""
    echo "=== –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è DNS ==="
    if [ -f "$BACKUP_RESOLV" ]; then
        cat "$BACKUP_RESOLV"
    else
        echo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
case "$1" in
    on|enable|start)
        turn_on
        ;;
    off|disable|stop)
        turn_off
        ;;
    status|check)
        check_status
        ;;
    dns|dns-status)
        show_dns
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
        echo ""
        show_help
        exit 1
        ;;
esac

exit 0
